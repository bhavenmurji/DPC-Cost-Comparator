generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String            @id @default(cuid())
  email             String            @unique
  passwordHash      String?
  name              String
  role              Role              @default(USER)
  emailVerified     Boolean           @default(false)
  verificationToken String?           @unique
  resetToken        String?           @unique
  resetTokenExpiry  DateTime?
  lastLogin         DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  comparisons       CostComparison[]
  claimedProvider   DPCProvider?
  savedComparisons  SavedComparison[]
  medications       UserMedication[]
  userProfiles      UserProfile?

  @@map("users")
}

model UserProfile {
  id                   String   @id @default(cuid())
  userId               String   @unique
  age                  Int
  zipCode              String
  state                String
  currentInsuranceType String?
  currentPremium       Float?
  currentDeductible    Float?
  currentOutOfPocket   Float?
  chronicConditions    String[]
  annualDoctorVisits   Int      @default(4)
  prescriptionCount    Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model CostComparison {
  id                      String            @id @default(cuid())
  userId                  String
  zipCode                 String
  age                     Int
  chronicConditions       String[]
  annualDoctorVisits      Int
  prescriptionCount       Int
  traditionalPremium      Float
  traditionalDeductible   Float
  traditionalOutOfPocket  Float
  traditionalTotalAnnual  Float
  dpcMonthlyFee           Float
  dpcAnnualFee            Float
  catastrophicPremium     Float
  catastrophicDeductible  Float
  catastrophicOutOfPocket Float
  dpcTotalAnnual          Float
  annualSavings           Float
  percentageSavings       Float
  recommendedPlan         PlanType
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  user                    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  matchedProviders        MatchedProvider[]

  @@index([userId])
  @@map("cost_comparisons")
}

model DPCProvider {
  id                  String             @id @default(cuid())
  claimedByUserId     String?            @unique
  claimedAt           DateTime?
  verified            Boolean            @default(false)
  npi                 String?            @unique
  name                String
  practiceName        String
  address             String
  city                String
  state               String
  zipCode             String
  latitude            Float?
  longitude           Float?
  phone               String
  email               String?
  website             String?
  monthlyFee          Float
  familyFee           Float?
  acceptingPatients   Boolean            @default(true)
  servicesIncluded    String[]
  patientCapacity     Int?
  currentPatientCount Int?
  specialties         String[]
  boardCertifications String[]
  languages           String[]
  rating              Float?
  reviewCount         Int                @default(0)
  viewCount           Int                @default(0)
  contactClickCount   Int                @default(0)
  websiteClickCount   Int                @default(0)
  lastViewedAt        DateTime?
  ribbonHealthId      String?
  turquoiseHealthId   String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  annualDiscount      String?
  childMonthlyFee     Float?
  enrollmentFee       Float?
  pricingConfidence   String?
  pricingNotes        String?
  pricingScrapedAt    DateTime?
  pricingTiers        Json?
  providerSource      DPCProviderSource?
  claimedBy           User?              @relation(fields: [claimedByUserId], references: [id])
  matchedProviders    MatchedProvider[]

  @@index([zipCode])
  @@index([state])
  @@index([claimedByUserId])
  @@map("dpc_providers")
}

model MatchedProvider {
  id            String         @id @default(cuid())
  comparisonId  String
  providerId    String
  distanceMiles Float
  matchScore    Float
  createdAt     DateTime       @default(now())
  comparison    CostComparison @relation(fields: [comparisonId], references: [id], onDelete: Cascade)
  provider      DPCProvider    @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([comparisonId])
  @@map("matched_providers")
}

model InsurancePlan {
  id                String   @id @default(cuid())
  planType          PlanType
  planName          String
  carrier           String
  state             String
  availableZipCodes String[]
  monthlyPremium    Float
  annualDeductible  Float
  maxOutOfPocket    Float
  primaryCareVisits Int?
  specialistVisits  Int?
  prescriptionTier1 Float?
  prescriptionTier2 Float?
  prescriptionTier3 Float?
  ageMin            Int?
  ageMax            Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([state])
  @@index([planType])
  @@map("insurance_plans")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  resource   String
  resourceId String?
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model PrescriptionPrice {
  id              String      @id @default(cuid())
  drugName        String
  genericName     String?
  dosage          String
  form            String
  quantity        Int
  zipCode         String
  pharmacyName    String
  pharmacyAddress String?
  price           Float
  memberPrice     Float?
  couponPrice     Float?
  couponUrl       String?
  source          PriceSource
  sourceId        String?
  cachedAt        DateTime    @default(now())
  expiresAt       DateTime
  ndc             String?     @unique

  @@index([drugName, zipCode])
  @@index([expiresAt])
  @@map("prescription_prices")
}

model LabTestPrice {
  id                String      @id @default(cuid())
  testName          String
  cptCode           String?
  loincCode         String?
  category          String?
  retailPrice       Float?
  cashPrice         Float
  dpcPrice          Float?
  insuranceEstimate Float?
  labProvider       LabProvider
  labLocation       String?
  lastUpdated       DateTime    @default(now())
  verified          Boolean     @default(false)

  @@index([testName])
  @@index([cptCode])
  @@map("lab_test_prices")
}

model PharmacySavingsProgram {
  id                 String                      @id @default(cuid())
  programName        String
  pharmacyChain      String
  programType        ProgramType
  requiresMembership Boolean                     @default(false)
  membershipCost     Float?
  membershipUrl      String?
  active             Boolean                     @default(true)
  lastVerified       DateTime                    @default(now())
  medications        PharmacySavingsMedication[]

  @@map("pharmacy_savings_programs")
}

model PharmacySavingsMedication {
  id          String                 @id @default(cuid())
  programId   String
  drugName    String
  genericName String
  dosage      String
  form        String
  price30Day  Float?
  price60Day  Float?
  price90Day  Float?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  program     PharmacySavingsProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@index([drugName])
  @@map("pharmacy_savings_medications")
}

model DPCProviderSource {
  id               String      @id @default(cuid())
  providerId       String      @unique
  source           String
  sourceUrl        String?
  sourceId         String?
  verified         Boolean     @default(false)
  lastScraped      DateTime?
  lastVerified     DateTime?
  dataQualityScore Float?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  provider         DPCProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("dpc_provider_sources")
}

model UserMedication {
  id              String   @id @default(cuid())
  userId          String
  drugName        String
  dosage          String
  frequency       String
  quantity        Int
  currentCost     Float?
  lowestCashPrice Float?
  insurancePrice  Float?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_medications")
}

model SavedComparison {
  id             String   @id @default(cuid())
  userId         String
  comparisonData Json
  name           String?
  notes          String?
  favorite       Boolean  @default(false)
  sharedPublicly Boolean  @default(false)
  shareToken     String?  @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([shareToken])
  @@map("saved_comparisons")
}

enum Role {
  ADMIN
  PROVIDER
  PARTNER
  USER
}

enum PlanType {
  TRADITIONAL
  DPC_CATASTROPHIC
  HIGH_DEDUCTIBLE
  PPO
  HMO
  EPO
}

enum PriceSource {
  GOODRX
  COSTCO
  WALMART
  CVS
  WALGREENS
  MANUFACTURER
  MANUAL
  NADAC
}

enum LabProvider {
  LABCORP
  QUEST
  ANYLABTESTNOW
  HEALTH_GORILLA
  DPC_AFFILIATE
  OTHER
}

enum ProgramType {
  GENERIC_DISCOUNT
  MEMBERSHIP_DISCOUNT
  MANUFACTURER_COUPON
  PATIENT_ASSISTANCE
}
